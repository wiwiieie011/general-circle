name: Deploy via Docker Compose

on:
  workflow_run:
    workflows: [ "Build and Push Images" ]
    types: [ completed ]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: SSH deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            # –ü—Ä–µ—Ä—ã–≤–∞–µ–º—Å—è –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
            set -e

            echo "üìÇ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å docker-compose: ${{ secrets.COMPOSE_DIR }}"
            if ! cd "${{ secrets.COMPOSE_DIR }}"; then
              echo "‚ùå –û—à–∏–±–∫–∞: –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ${{ secrets.COMPOSE_DIR }} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
              exit 1
            fi

            echo "‚¨áÔ∏è –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ Docker-–æ–±—Ä–∞–∑—ã"
            if ! docker compose pull; then
              echo "‚ùå –û—à–∏–±–∫–∞: docker compose pull –Ω–µ —É–¥–∞–ª—Å—è"
              exit 1
            fi

            echo "üöÄ –ü–æ–¥–Ω–∏–º–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
            if ! docker compose up -d; then
              echo "‚ùå –û—à–∏–±–∫–∞: docker compose up –Ω–µ —É–¥–∞–ª—Å—è"
              exit 1
            fi

            echo "üßπ –ß–∏—Å—Ç–∏–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ Docker-–æ–±—Ä–∞–∑—ã"
            docker image prune -f || echo "‚ö†Ô∏è docker image prune –Ω–µ —É–¥–∞–ª—Å—è, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º"

            echo "‚úÖ Deploy –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!"
