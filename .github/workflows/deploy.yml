name: Deploy via Docker Compose

on:
  workflow_run:
    workflows: ["Build and Push Images"]
    types: [completed]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Check required secrets
        run: |
          echo "üîπ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤..."
          : "${{ secrets.SSH_HOST:?‚ùå SSH_HOST –Ω–µ –∑–∞–¥–∞–Ω!}}"
          : "${{ secrets.SSH_USER:?‚ùå SSH_USER –Ω–µ –∑–∞–¥–∞–Ω!}}"
          : "${{ secrets.SSH_KEY:?‚ùå SSH_KEY –Ω–µ –∑–∞–¥–∞–Ω!}}"
          : "${{ secrets.COMPOSE_DIR:?‚ùå COMPOSE_DIR –Ω–µ –∑–∞–¥–∞–Ω!}}"
          echo "‚úÖ –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."

      - name: Debug env
        run: |
          echo "COMPOSE_DIR=${{ secrets.COMPOSE_DIR }}"
          echo "SSH_HOST=${{ secrets.SSH_HOST }}"
          echo "SSH_USER=${{ secrets.SSH_USER }}"

      - name: SSH deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            echo "üìÇ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å docker-compose: ${{ secrets.COMPOSE_DIR }}"
            if ! cd "${{ secrets.COMPOSE_DIR }}"; then
              echo "‚ùå –û—à–∏–±–∫–∞: –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ${{ secrets.COMPOSE_DIR }} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
              exit 1
            fi

            echo "‚¨áÔ∏è –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ Docker-–æ–±—Ä–∞–∑—ã"
            if ! docker compose pull; then
              echo "‚ùå –û—à–∏–±–∫–∞: docker compose pull –Ω–µ —É–¥–∞–ª—Å—è"
              exit 1
            fi

            echo "üöÄ –ü–æ–¥–Ω–∏–º–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
            if ! docker compose up -d; then
              echo "‚ùå –û—à–∏–±–∫–∞: docker compose up –Ω–µ —É–¥–∞–ª—Å—è"
              exit 1
            fi

            echo "üßπ –ß–∏—Å—Ç–∏–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ Docker-–æ–±—Ä–∞–∑—ã"
            docker image prune -f || echo "‚ö†Ô∏è docker image prune –Ω–µ —É–¥–∞–ª—Å—è, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º"

            echo "‚úÖ Deploy –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!"
