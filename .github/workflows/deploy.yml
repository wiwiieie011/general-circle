name: Deploy via Docker Compose

on:
  workflow_run:
    workflows: ["Build and Push Images"]
    types: [completed]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Debug env
        run: |
          echo "COMPOSE_DIR=${{ secrets.COMPOSE_DIR }}"

      - name: SSH deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            echo "üìÇ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: ${{ secrets.COMPOSE_DIR }}"
            cd "${{ secrets.COMPOSE_DIR }}"
            echo "‚¨áÔ∏è –ó–∞–≥—Ä—É–∂–∞–µ–º Docker-–æ–±—Ä–∞–∑—ã"
            docker compose pull
            echo "üöÄ –ü–æ–¥–Ω–∏–º–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
            docker compose up -d
            echo "üßπ –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ Docker-–æ–±—Ä–∞–∑—ã"
            docker image prune -f
            echo "‚úÖ Deploy –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!"
